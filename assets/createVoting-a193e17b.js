import"./main-96991ec2.js";import{c as T,i as x}from"./notification-39e0ad74.js";import{a as f}from"./enc-utf8-c5181946.js";import{f as D}from"./index-a4e39586.js";import{s as E}from"./showStars-385adb56.js";import{s as m}from"./showDateTime-51bda516.js";const l="https://teatimeapi-test.onrender.com",C=localStorage.getItem("token"),N=T(C);moment().format("YYYY/MM/DD");x(C)?I():window.location.href="./calendar.html";let i={category:"全部",sort:"",search:""};const q={newestStore:"&_sort=id&_order=desc",bestStore:"&_sort=stars&_order=desc",worstStore:"&_sort=stars&_order=asc"};function I(e,t,n){let s="",o="",r="";e!=="全部"&&e&&(s=`category=${e}`),t&&(o=t),n&&(r=`&storeName_like=${n}`);let a=`${l}/restaurants?${s}${o}${r}`;U(a)}const Y=document.querySelectorAll(".btnSortStore");Y.forEach(e=>{e.addEventListener("click",function(){const t=this.getAttribute("data-sort-value");d("sort",t)})});const A=document.querySelectorAll(".btnCategoryStore");A.forEach(e=>{e.addEventListener("click",function(){const t=this.getAttribute("data-category-value");d("category",t)})});function d(e,t){switch(e){case"category":i[e]=t;break;case"search":i[e]=t.trim();break;default:i[e]=q[t];break}I(i.category,i.sort,i.search)}function U(e){$(function(){(function(t){let n=$("#pagination"+t);$.ajax({url:e,success:function(s){j(s,n)},error:function(s){console.error(s.message)}})})("Pages")})}function j(e,t){t.pagination({dataSource:e,totalNumber:e.length,pageSize:8,showPageNumbers:!0,showPrevious:!0,showNext:!0,callback:function(n,s){M(n),V()}})}function M(e){const t={飲料:"icon-park-outline:drink",速食:"mdi:food-outline",素食:"tabler:leaf",小吃:"ph:bowl-food",甜點:"material-symbols:icecream-outline-rounded",咖啡:"icon-park-outline:tea-drink"};let n='<ul class="row row-cols-2 gap-12 gap-xxl-24 findStore-ul">';$.each(e,function(s,o){const r=c.hasOwnProperty(o.UID);n+=`<li class="findStore-img position-relative" style="background-image: url(${o.storeCover});"> 
                        <!-- select-store-checkbox --> 
                        <label class="select-store">
                            <input type="checkbox" class="position-absolute select-store-checkbox" name="selectStoreCheck${o.UID}" data-uid="${o.UID}" ${r?"checked":""}>
                            <span class="position-absolute cursor-pointer select-store-checkmark"></span></label>
                            <a href="store-order.html?UID=${o.UID}" class="d-flex justify-content-center w-100 h-100 ">
                                <!-- restaurant info -->
                                <div class="position-absolute d-flex justify-content-between findStore-card">
                                    <div class="d-flex flex-column justify-content-center overflow-hidden">
                                        <p class="mb-8 fs-md-20 fs-16 lh-sm text-white" style="white-space:nowrap">${o.storeName}</p>
                                        <!-- 星評 -->
                                        <div class="d-flex ">
                                            ${E(o.stars)}
                                        </div>
                                    </div>
                                    <!-- restaurant sort -->
                                    <iconify-icon icon="${t[o.category]}"
                                        style="color: #8b8b8a;" width="24" height="24"
                                        class="ms-4 findStore-card-img"></iconify-icon>
                                </div>
                            </a>
                        </li>`}),n+="</ul>",$("#paginationContainer").html(n)}const c={};function V(){const e=document.querySelectorAll("input[type='checkbox']"),t=3;e.forEach(n=>{n.addEventListener("change",function(){const s=this.getAttribute("data-uid"),o=c.hasOwnProperty(s);Object.keys(c).length===t&&!o?this.checked=!1:o?(delete c[s],p()):f.get(`${l}/restaurants?UID=${s}`).then(function(a){c[s]=_(a.data[0]),p()}).catch(a=>{console.error(a.message)})})})}function _(e){return{UID:e.UID,restaurantId:e.id,restaurantName:e.storeName,restaurantCover:e.storeCover,summary:e.summary,minGroupSize:e.minGroupSize}}function B(){const e=document.querySelector(".checkedStoreContainer");Object.keys(c).length>0?e.classList.remove("d-none"):e.classList.add("d-none")}function p(){const e=document.querySelector(".showCheckedList");let t="";Object.values(c).forEach(n=>{t+=`<li class="d-flex align-items-center py-10 px-20 py-md-12 px-md-24 gap-8 rounded-pill bg-gray-04">
                                <span class="fs-12 fs-md-16 fw-medium">${n.restaurantName}</span>
                                <button type="button" class="btn-close cancelCheckedStore" data-uid=${n.UID}></button>
                            </li>`}),e.innerHTML=t,H(),B(),P()}function H(){document.querySelectorAll(".cancelCheckedStore").forEach(t=>{t.addEventListener("click",function(){const n=this.getAttribute("data-uid"),s=document.querySelector(`input[data-uid=${n}]`);s&&(s.checked=!1),delete c[n],p()})})}function P(){const e=document.querySelector(".checkCheckedStoreAbove"),t=document.querySelector(".checkCheckedStoreBelow");Object.keys(c).length>1?(e.classList.add("d-sm-block"),t.classList.remove("d-none"),t.classList.add("d-block","d-sm-none")):(e.classList.remove("d-sm-block"),t.classList.add("d-none"))}const w=document.getElementById("modal-createVoting"),O=w.querySelector(".modal-title"),g=document.getElementById("eventDateTime"),v=document.getElementById("deadlineDateTime"),y=document.getElementById("votingInvitees"),F=document.querySelector(".votingCard"),z=document.querySelector(".btnCreateVoting");w.addEventListener("show.bs.modal",async function(e){h=(await f.get(`${l}/users?UID=${N}`)).data[0].userName;const n=Object.values(c);G(n),R(n)});let h="";async function G(e){const t=document.querySelector(".votingInitiator");t.textContent=h;const n=e.map(k=>k.restaurantName);O.textContent=n.join("、");const s=g._flatpickr,o=v._flatpickr,r=sessionStorage.getItem("eventDateTime"),a=sessionStorage.getItem("deadlineDateTime"),u=sessionStorage.getItem("votingInvitees");s.setDate(r,!0),o.setDate(a,!0),y.value=u}function R(e){let t="";e.forEach(n=>{t+=`
                            <li class="d-flex gap-12 p-12 mb-12 border border-brand-03 border-radius-40401616">
                                <img class="border-radius-32321616 votingcard-photo" src="${n.restaurantCover}">
                                <div>
                                <h4 class="mb-8 fs-16 fs-md-20 lh-sm text-brand-03">${n.restaurantName}</h4>
                                <p class="mb-8 mb-md-16 text-gray-02 trippleline-ellipsis">${n.summary}</p>
                                <div>
                                <span class="me-16 text-gray-02 text-nowrap">成團目標</span>
                                <span class="text-gray-02">${n.minGroupSize} 人</span>
                                </div>                                 
                            </li>`}),F.innerHTML=t}z.addEventListener("click",J);let b="";async function J(){if(X()){$("#modal-createdSuccess").modal("hide"),$("#modal-createVoting").modal("show");return}try{b=await K(),Q(b),$("#modal-createdSuccess").modal("show")}catch(t){console.error("錯誤:",t)}}async function K(){try{const t=(await f.get(`${l}/votings`)).data,s=t[t.length-1].UID.match(/(\D+)(\d+)/);if(s){const o=s[1];let r=parseInt(s[2]);return r++,o+r.toString().padStart(s[2].length,"0")}}catch(e){throw console.error("錯誤:",e),e}}function Q(e){const t=Object.values(c),n=[];t.forEach(s=>{const o={...s};delete o.restaurantCover,delete o.summary,delete o.minGroupSize,o.UID=e,o.deadlineDateTime=v.value,o.eventDateTime=g.value,o.initiator=h,o.invitees=y.value==="has-invitees"?h:"",o.currentVoters=[],n.push(o)}),W(n)}function W(e){let t=0;function n(s){f.post(`${l}/votings`,s).then(function(o){t++,t<e.length&&n(e[t])}).catch(o=>{console.error(o.message)})}n(e[t])}function X(){let e=!1;const t=document.querySelector(".eventDateTimeAlert"),n=document.querySelector(".deadlineDateTimeAlert"),s=document.querySelector(".votingInviteesAlert");let o="",r="";const a=g.value.trim(),u=v.value.trim();return a&&(o=moment(a,"YYYY/MM/DD HH:mm")),u&&(r=moment(u,"YYYY/MM/DD HH:mm")),o===""?(t.classList.remove("d-none"),e=!0):t.classList.add("d-none"),r===""?(n.classList.remove("d-none"),n.textContent="必填",e=!0):n.classList.add("d-none"),y.value===""?(s.classList.remove("d-none"),e=!0):s.classList.add("d-none"),o&&r&&(o.diff(r,"hours")<24?(n.classList.remove("d-none"),n.textContent="截止時間須至少提前於享用日期 24 時",e=!0):n.classList.add("d-none")),e}const L=document.getElementById("modal-createdSuccess");L.addEventListener("show.bs.modal",function(e){const t=g.value.trim(),n=v.value.trim();document.querySelector(".eventDateTime-Date").textContent=m(t)[0],document.querySelector(".eventDateTime-Time").textContent=m(t)[1],document.querySelector(".deadlineDateTime-Date").textContent=m(n)[0],document.querySelector(".deadlineDateTime-Time").textContent=m(n)[1]});L.addEventListener("show.bs.modal",function(e){document.querySelector(".btnLinkToCalendar").addEventListener("click",function(){window.location.href=`./calendar.html?UID=${b}`})});const S=new autoComplete({data:{src:async e=>{try{return await(await fetch(`${l}/restaurants`)).json()}catch(t){return t}},keys:["storeName"]},searchEngine:"loose",debounce:300,resultItem:{highlight:!0},resultsList:{element:(e,t)=>{if(!t.results.length){const n=document.createElement("div");n.setAttribute("class","no_result px-8"),n.innerHTML=`<span>Found No Results for "${t.query}"</span>`,e.prepend(n)}},noResults:!0},events:{input:{selection:e=>{const t=e.detail.selection.value;S.input.value=t.storeName,d("search",t.storeName)},keydown:e=>{if(e.keyCode===13){const t=S.input.value;d("search",t)}}}}}),Z=document.getElementById("autoComplete");Z.addEventListener("input",function(e){d("search","")});D("#eventDateTime",{enableTime:!0,dateFormat:"Y/m/d H:i",time_24hr:!0,minuteIncrement:15,allowInput:!0,minDate:moment().format("YYYY/MM/DD")});D("#deadlineDateTime",{enableTime:!0,dateFormat:"Y/m/d H:i",time_24hr:!0,minuteIncrement:15,allowInput:!0,minDate:moment().format("YYYY/MM/DD")});$(".btnSortStore").click(function(e){$(".btnSortStore").removeClass("btn-active-brand-02"),$(this).addClass("btn-active-brand-02")});$(".categoryStoreBar button").click(function(e){$(".categoryStoreBar button").removeClass("actived"),$(this).addClass("actived")});
